<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio2 Rainforest & LEO Master</title>
    
    <!-- Chart Engine -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #0f172a;
            --sidebar: #1e293b;
            --card: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --accent: #38bdf8; /* Sky blue */
            --border: #334155;
        }

        body {
            margin: 0; background-color: var(--bg); color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* SIDEBAR */
        aside {
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
        }
        .brand {
            padding: 25px; font-size: 1.1rem; font-weight: 800; color: white;
            border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;
        }
        .group-header {
            padding: 20px 20px 8px; font-size: 0.75rem; text-transform: uppercase;
            color: var(--muted); font-weight: 700; letter-spacing: 1px;
        }
        .nav-item {
            padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent;
            transition: 0.2s; color: #cbd5e1; font-size: 0.9rem;
            display: flex; justify-content: space-between;
        }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #0f172a; border-left-color: var(--accent); color: var(--accent); }
        .count-badge { background: #334155; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

        /* MAIN */
        main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        header {
            padding: 20px 40px; background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }

        .grid {
            padding: 30px; display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); 
            gap: 25px;
        }

        .card {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; height: 400px; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .card h3 { 
            margin: 0 0 10px 0; font-size: 0.95rem; color: var(--muted); 
            text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 10px;
            display: flex; justify-content: space-between;
        }
        .unit-tag { color: var(--accent); font-size: 0.8rem; font-weight: bold; }

        /* LOADING */
        .loading-overlay {
            position: absolute; inset: 0; background: var(--card); z-index: 10;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-size: 2rem; color: var(--accent);
        }
        .error-msg { color: #f87171; font-size: 1rem; padding: 20px; text-align: center; }

    </style>
</head>
<body>

    <aside>
        <div class="brand"><i class="fa-solid fa-tower-broadcast"></i> BIO2 SENSOR NET</div>
        <div id="nav-container">
            <!-- Navigation built dynamically -->
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h1 id="page-title" style="margin:0; font-size:1.4rem;">Select a Sensor Group</h1>
                <div style="font-size:0.8rem; color:var(--muted); margin-top:5px;">
                    <i class="fa-solid fa-circle-check" style="color:#10b981;"></i> VPN Connected
                </div>
            </div>
            <div id="cors-warning" style="display:none; background:#7f1d1d; padding:10px 20px; border-radius:6px; font-size:0.8rem; color:#fca5a5; border:1px solid #ef4444;">
                <i class="fa-solid fa-triangle-exclamation"></i> <strong>CORS Blocked:</strong> Enable browser extension.
            </div>
        </header>

        <div id="chart-grid" class="grid">
            <!-- Charts go here -->
        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION MASTER LIST ---
        // Maps the exact structure from the University website
        const GROUPS = [
            {
                category: "Rainforest Towers",
                items: [
                    { 
                        name: "Mountain Tower", 
                        sensors: [
                            { label: "Temp & RH", file: "vis_mnttower", vars: "15_16", unit: "°C / %", jsp: "TimeSeries.jsp" },
                            { label: "Wind Speed", file: "vis_mnttower", vars: "21", unit: "m/s", jsp: "TimeSeries.jsp" },
                            { label: "PAR & Radiation", file: "vis_mnttower", vars: "12_19", unit: "W/m²", jsp: "TimeSeries.jsp" },
                            { label: "Short/Long Rad", file: "vis_mnttower", vars: "6_7_8_9_10", unit: "W/m²", jsp: "TimeSeriesRad.jsp" }
                        ]
                    },
                    { 
                        name: "Northwest Tower", 
                        sensors: [
                            { label: "Temp & RH", file: "vis_nwtower", vars: "15_16", unit: "°C / %", jsp: "TimeSeries.jsp" },
                            { label: "Wind Speed", file: "vis_nwtower", vars: "21", unit: "m/s", jsp: "TimeSeries.jsp" },
                            { label: "PAR & Radiation", file: "vis_nwtower", vars: "12_19", unit: "W/m²", jsp: "TimeSeries.jsp" }
                        ]
                    },
                    { 
                        name: "Northeast Tower", 
                        sensors: [
                            { label: "Temp & RH", file: "vis_netower", vars: "15_16", unit: "°C / %", jsp: "TimeSeries.jsp" },
                            { label: "Wind Speed", file: "vis_netower", vars: "21", unit: "m/s", jsp: "TimeSeries.jsp" },
                            { label: "Air Pressure", file: "vis_netower", vars: "33", unit: "hPa", jsp: "TimeSeries.jsp" },
                            { label: "PAR & Radiation", file: "vis_netower", vars: "12_19", unit: "W/m²", jsp: "TimeSeries.jsp" }
                        ]
                    },
                    { 
                        name: "South Tower", 
                        sensors: [
                            { label: "Temp & RH", file: "vis_stower", vars: "15_16", unit: "°C / %", jsp: "TimeSeries.jsp" },
                            { label: "Wind Speed", file: "vis_stower", vars: "21", unit: "m/s", jsp: "TimeSeries.jsp" },
                            { label: "PAR & Radiation", file: "vis_stower", vars: "12_19", unit: "W/m²", jsp: "TimeSeries.jsp" }
                        ]
                    }
                ]
            },
            {
                category: "Rainforest Soil (Pedons)",
                items: [
                    {
                        name: "Northwest Pedon",
                        sensors: [
                            { label: "Soil Temp", file: "vis_nwpedon", vars: "25", unit: "°C", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Soil Moisture", file: "vis_nwpedon", vars: "24", unit: "%", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Water Potential", file: "vis_nwpedon", vars: "27", unit: "kPa", jsp: "TimeSeriesSoil.jsp" }
                        ]
                    },
                    {
                        name: "Northeast Pedon",
                        sensors: [
                            { label: "Soil Temp", file: "vis_nepedon", vars: "25", unit: "°C", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Soil Moisture", file: "vis_nepedon", vars: "24", unit: "%", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Water Potential", file: "vis_nepedon", vars: "27", unit: "kPa", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Elec. Conductivity", file: "vis_nepedon", vars: "26", unit: "mS/cm", jsp: "TimeSeriesSoil.jsp" }
                        ]
                    },
                    {
                        name: "South Pedon",
                        sensors: [
                            { label: "Soil Temp", file: "vis_spedon", vars: "25", unit: "°C", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Soil Moisture", file: "vis_spedon", vars: "24", unit: "%", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Water Potential", file: "vis_spedon", vars: "27", unit: "kPa", jsp: "TimeSeriesSoil.jsp" },
                            { label: "Elec. Conductivity", file: "vis_spedon", vars: "26", unit: "mS/cm", jsp: "TimeSeriesSoil.jsp" }
                        ]
                    }
                ]
            },
            {
                category: "LEO / General",
                items: [
                    {
                        name: "LEO Outdoor",
                        sensors: [
                            { label: "Temp & RH", type: "leo", id: "4", unit: "°C / %" },
                            { label: "Photon Flux", type: "leo", id: "5", unit: "µmol" },
                            { label: "Global Rad A", type: "leo", id: "6", unit: "W/m²" },
                            { label: "Global Rad B", type: "leo", id: "7", unit: "W/m²" },
                            { label: "UV Radiation", type: "leo", id: "11", unit: "W/m²" }
                        ]
                    },
                    {
                        name: "Weather Station",
                        sensors: [
                            { label: "Weatherhawk", type: "leo", id: "10", unit: "Mixed" },
                            { label: "Air Pressure", type: "leo", id: "12", unit: "hPa" }
                        ]
                    }
                ]
            }
        ];

        const CD_OFFSET = 62135596800; // 0001 to 1970
        let activeCharts = [];

        // --- 2. INITIALIZATION ---
        function init() {
            const nav = document.getElementById('nav-container');
            
            GROUPS.forEach((group, gIdx) => {
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerText = group.category;
                nav.appendChild(header);

                group.items.forEach((item, iIdx) => {
                    const el = document.createElement('div');
                    el.className = 'nav-item';
                    el.innerHTML = `<span>${item.name}</span> <span class="count-badge">${item.sensors.length}</span>`;
                    el.onclick = () => loadGroup(gIdx, iIdx);
                    nav.appendChild(el);
                });
            });

            // Load first item by default
            loadGroup(0, 2); // Default to NE Tower
        }

        // --- 3. DATA LOADING ---
        async function loadGroup(gIdx, iIdx) {
            // UI Update
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            // Find the clicked element (rough logic for demo)
            // Ideally assign IDs, but index works here
            const allNavs = document.querySelectorAll('.nav-item');
            let counter = 0;
            GROUPS.forEach(g => counter += g.items.length); // simple counter logic omitted for brevity
            // Just assume user clicked, manual highlight logic skipped for brevity
            
            const groupData = GROUPS[gIdx].items[iIdx];
            document.getElementById('page-title').innerText = groupData.name;
            const grid = document.getElementById('chart-grid');
            
            // Cleanup
            grid.innerHTML = '';
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            // Parallel Fetch
            groupData.sensors.forEach((sensor, index) => {
                createChartCard(sensor, index);
                fetchSensorData(sensor, index);
            });
        }

        function createChartCard(sensor, index) {
            const grid = document.getElementById('chart-grid');
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <h3>
                    <span>${sensor.label}</span>
                    <span class="unit-tag">${sensor.unit}</span>
                </h3>
                <div id="loader_${index}" class="loading-overlay"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                <canvas id="canvas_${index}"></canvas>
            `;
            grid.appendChild(div);
        }

        async function fetchSensorData(sensor, index) {
            let url = "";
            if (sensor.type === 'leo') {
                url = `https://data.b2.arizona.edu/LEOGeneral/TimeSeriesPlot.jsp?sensor=${sensor.id}`;
            } else {
                // Rainforest logic
                const jsp = sensor.jsp || 'TimeSeries.jsp';
                url = `https://data.b2.arizona.edu/B2RainforestPlots/${jsp}?file=${sensor.file}&vars=${sensor.vars}&npl=1`;
            }

            try {
                const response = await fetch(url);
                const html = await response.text();
                
                // Parse
                const regex = /window\.chart(\d+)_chartModel\s*=\s*(\{[\s\S]*?\});/g;
                let match;
                const datasets = [];

                while ((match = regex.exec(html)) !== null) {
                    const dataObj = new Function("return " + match[2])();
                    const layer = dataObj.layers[0];
                    const xVals = layer.xValues;

                    layer.dataSets.forEach((ds, i) => {
                        let colorHex = '#' + ('000000' + (ds.color & 0xFFFFFF).toString(16)).slice(-6);
                        
                        // Fix Black/White/Invisible lines
                        if (colorHex === '#000000' || colorHex === '#ffffff') {
                            const colors = ['#38bdf8', '#34d399', '#f472b6', '#fbbf24'];
                            colorHex = colors[i % colors.length];
                        }

                        datasets.push({
                            label: ds.id || `${sensor.label} ${i+1}`,
                            data: ds.data.map((v, k) => ({
                                x: (xVals[k] - CD_OFFSET) * 1000,
                                y: v
                            })),
                            borderColor: colorHex,
                            backgroundColor: colorHex + '15',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            fill: true,
                            tension: 0.1
                        });
                    });
                }

                if (datasets.length === 0) throw new Error("No data found");

                // Render
                document.getElementById(`loader_${index}`).style.display = 'none';
                renderChart(index, datasets, sensor.unit);

            } catch (err) {
                console.error(err);
                const loader = document.getElementById(`loader_${index}`);
                loader.innerHTML = '<div class="error-msg">Connection Blocked.<br>Check CORS Extension.</div>';
                document.getElementById('cors-warning').style.display = 'block';
            }
        }

        function renderChart(index, datasets, unit) {
            const ctx = document.getElementById(`canvas_${index}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd', hour: 'HH:mm' } },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', maxRotation: 0 }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: unit, color: '#64748b' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0', usePointStyle: true } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#38bdf8',
                            bodyFont: { size: 13 },
                            padding: 12,
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' ' + (unit.includes('/') ? '' : unit);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            activeCharts.push(chart);
        }

        window.onload = init;

    </script>
</body>
</html>